Windows Forensics - Registry
https://tryhackme.com/room/windowsforensics1

- Windows Registry
	- A collection of databases that contain the system's configuration data
		- Hardware
		- Software
		- User Information
	- Registry Hive
		- https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-hives
		- A group of keys, subkeys and values stored in a single file on the disk
		- A User Hive for example, contains specific registry information, :
			- Application settings
			- Desktop
			- Environment
			- network connections
			- printers
			- `HKEY_USERS`
	- Structure of Registry:
		- `HKEY_CURRENT_USER`
			- Contains the root of the configuration information for the user who is *currently* logged on
			- Folders, screen colours, control panel settings are stored here
			- Associated with the user's profile
			- Subkey of `HKEY_USERS` or `HKU`
			- Abbreviated as `HKCU`
		- `HKEY_USERS`
			- Contains all actively loaded user profiles on the computer
			- Abbreviation of `HKU`
		- `HKEY_LOCAL_MACHINE`
			- Contains configuration information particular to the computer (for any user)
			- Abbreviated `HKLM`
		- `HKEY_CLASSES_ROOT`
			- Subkey of `HKLM\Software`
			-  Information here makes sure that the correct program opens when you open a file by using Windows Explorer
			- `HKLM\Software\Classes` key
				- Contains default settings that can apply to all users on the local computer
			- `HKCU\Software\Classes` key
				- Contains settings that override the default settings and apply only to the interactive user
			- `HKCR` key
				- Provides a view of the registry that merges the information from the two sources/keys above
				- Also provides a view for earlier versions of Windows
			- Changes for the current interactive user must be made within the `HKCU\Software\Classes` key instead of within `HKCR`
			- Abbreviated to `HKCR`
		- `HKEY_CURRENT_CONFIG`
			- Contains information about the hardware profile that is used by the local computer at system startup
			  
- Accessing Registry Hives Offline
	- The majority of Registry Hives are located in:
		- `C:\Windows\System32\Config`
	- `DEFAULT` - mounted on `HKU\DEFAULT`
	- `SAM` - mounted on `HKLM\SAM`
	- `SECURITY` - mounted on `HKLM\Security`
	- `SOFTWARE` - mounted on `HKLM\Software`
	- `SYSTEM` -  mounted on `HKLM\System`
	  
- Hives Containing User Information
	- Hives containing user information can be found in the User Profile directory
		- `C:\Users\<profile/user-name>`
			- `NTUSER.DAT` - mounted on `HKCU`
				- Located in `C:\Users\<profile/user-name>\`
			- `USRCLASS.DAT` - mounted on `HKCU\Software\CLASSES`
				- located in the directory `C:\Users\<profile/user-name>\Appdata\Local\Microsoft\Windows`
			- These two `.DAT` files are *hidden*
			  
- The AmCache Hive
	- Located in:
		- `C:\Windows\AppCompat\Programs\Amcache.hve`
	- Saves information on programs that were recently run on the system
	  
- Transaction Logs and Registry Backups:
	- Transaction Logs:
		- Transaction logs can be considered as the journal of the changelog of the registry hive
		- Windows often uses the transaction logs when writing data to registry hives
		- Meaning that transaction logs can often have the latest changes in the registry that haven't made their way to the registry hives themselves
		- Transaction log for each hive is stored as a `.LOG` file in the same directory as the hive itself, with the same name as the registry hive (with the `.LOG` extension though)
		- There can be multiple transaction logs for a registry hive, `.LOG .LOG1 .LOG2` etc
	- Registry Backups
		- Backups of the registry hives that are located in `C:\Windows\System32\Config` and are copied to `C:\Windows\System32\Config\RegBack`
		- Copied every 10 days
		- Good place to look if you think that some registry keys have been deleted or modified

- Data Acquisition
	- The process of imaging or copying a system or the required data to perform forensics on it
	- Keeping in mind that registry files are restricted files, so how can we make a copy of them?
		- Tools, such as
			- KAPE
			- Autopsy
			- FTK Imager
	- Bear in mind that these tools are used to *acquire* the needed registry hives

- Exploring Windows Registry
	- Tools will be needed, such as
		- Registry Viewer
			- https://www.exterro.com/ftk-product-downloads/registry-viewer-2-0-0
			- Only holds one hive at a time, and it can't take transaction logs
		- Zimmerman's Registry Explorer
			- https://ericzimmerman.github.io/#!index.md
			- Can load multiple hives simultaneously and add data from transaction logs into the hive to make a more *cleaner* hive with more up-to-date data
			- Also has a Bookmarks option, which can contain important registry keys usually sought out by investigators
		- RegRipper
			- Takes a registry hive as an input and outputs a report that extracts data from some of the forensically important keys and values in that hive
			- Output report is a text file and shows results in a sequential order
			- Doesn't take transaction logs into account.
			- Registry Explorer can be used to merge transaction logs with related registry hives before sending the output to RegRipper for processing

- System Information and System Accounts
	- OS Version
		- `SOFTWARE\Microsoft\Windows NT\CurrentVersion`
	- Control Sets
		- Configuration data used for controlling system startup are called Control Sets
		- Usually, in the `SYSTEM` hive - there will be ControlSet001 and ControlSet002
		- In most cases (most, not all), ControlSet001 will point to the Control Set that the machine booted with
		- ControlSet002 will be the `last known good` configuration
		- Locations:
			- `SYSTEM\ControlSet001`
			- `SYSTEM\ControlSet002`
	- Current Control Set
		- A volatile control set when the machine is live, called the CurrentControlSet
		- `HKLM\SYSTEM\CurrentControlSet`
		- `SYSTEM\Select\Current`
			- Which Control Set is being used as the CurrentControlSet
		- `SYSTEM\Select\LastKnownGood`
			- Will outline which Control Set is being used for the Last Known Good configuration
	- *Vital to establish this information before moving forward with the analysis.*
		- *Many artifacts will be collected from these Control Sets - keep that in mind*
	- Computer Name
		- `SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName`
		- Ensure we are working on the machine that we are supposed to be working on (important for any analysis really)
	- Time Zone Information
		- `SYSTEM\CurrentControlSet\Control\TimeZoneInformation`
		- Important to establish what time zone the computer is located in 
		- Helps to establish a good understanding of the chronology of events as they happened
		- Important because some data in the computer will have their timestamps in the UTC/GMT zones and others in the local time zones. 
		- Knowledge of the local time zone helps in establishing a timeline when merging data from all sources
	- Network Interfaces and Past Networks
		- `SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces`
		- Each interface is represented with a GUID subkey
			- Contains values relating to the interface's TCP/IP configuration
			- Helps provide information like IP addresses, DHCP IP address, Subnet Masks, Default Router, DNS Servers, and more
		- Significant information as it will help ensure that we are performing forensics on a machine that we are supposed to be performing on
		- Past networks a machine was connected to can be found in:
			- `SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Signature\Unmanaged`
			- `SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Signatures\Managed`
			- These keys contain past networks as well as the time they were connected
				- The last write time of the registry keys point to the last time these networks were connected
	- Autostart Programs
		- These keys include information about programs or commands that run when a user logs on
			- `NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Run`
			- `NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\RunOnce`
			- `SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce`
			- `SOFTWARE\Microsoft\Windows\CurrentVersion\policies\Explorer\Run`
			- `SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
		- This registry key contains information about services
			- `SYSTEM\CurrentControlSet\Services`
				- If the `start` key is set to `0x02`, it means that this service will start at boot
	- SAM Hive and User Information
		- `SAM\Domains\Account\Users`
		- Contains
			- User account information
			- Login information
			- Group information
			- Relative Identifer (RID) of the user
			- Number of times the user logged in 
			- Last login time
			- Last password change
			- Password expiry
			- Password Policy
			- Password hint
			- Any group memberships

- Usage or Knowledge of Files/Folders
	- Recent Files
		- Stored in the NTUSER hive
		- `NTUSER.dat\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs`
		- Registry Explorer tool allows sorting of data contained in the registry keys quickly
			- Most Recently Used (MRU) at the top for example
		- Also the Recent Files key can contain keys for different file extensions, such as `.pdf`, `.jpg`, `.docx` for example
		- If looking for a particular one:
			- `NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs\.docx` 
		- Registry Explorer tools also lists the Last Opened Time of files
	- Office Recent Files
		- `NTUSER.DAT\Software\Microsoft\Office\VERSION`
		- Example:
			- `NTUSER.DAT\Software\Microsoft\Office\15.0\Word`
				- `15.0` refers to Office 2013
		- Different Office Releases:
			- https://learn.microsoft.com/en-us/microsoft-365-apps/deploy/install-different-office-visio-and-project-versions-on-the-same-computer#office-releases-and-their-version-number\
		- Office365 and later, Microsoft has now tied the location to the user's Live ID 
			- `NTUSER.DAT\Software\Microsoft\Office\VERSION\UserMRU\LIVEID_####\FileMRU`
	- ShellBags
		- When a user opens a folder, the folder opens in a specific layout
		- Users have the ability to change this layout so it meets their preferences
		- Layouts can be different for different folders
		- This information about the *Windows Shell* is sotred and can identify the MRU (Most Recently Used) files and folders
		- Since it's a setting that is different for each user, it is located within the User Hives - in these locations:
			- `USRCLASS.DAT\Local Settings\Software\Microsoft\Windows\Shell\Bags`
			- `USRCLASS.DAT\Local Settings\Software\Microsoft\Windows\Shell\BagMRU`
			- `NTUSER.DAT\Software\Microsoft\Windows\Shell\BagMRU`
			- `NTUSER.DAT\Softwware\Microsoft\Windows\Shell\Bags`
		- A tool from Zimmerman called **ShellBag Explorer** can be used to show information in an easy-to-use format
	- Open/Save and Last Visited DIalog MRUs:
		- When a file is opened or saved, a dialogue box appears prompting the user where to save or open that file from
		- Windows then remembers that location
		- `NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\OpenSavePIDMRU`
		- `NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\LastVisitedPidlMRU`
	- Windows Explorer Address / Search Bars
		- Another way to identify a user's recent activity is by looking at the paths entered into the Windows Explorer address bar or searches performed using these registry keys:
			- `NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\TypedPaths`
			- `NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\WordWheelQuery`

- Evidence of Execution
	- UserAssist
		- Windows keeps track of applications launched by the user using Windows Explorer for statistical purposes in the User Assist registry keys
		- Programs run from the command line can't be found in the User Assist keys
		- User Assist key is in the NTUSER hive, mapped to each user's GUID
		- `NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{GUID}\Count`
	- ShimCache
		- A mechanism used to keep track of application compatibility with the OS and tracks all applications launched on the machine
		- Main purpose is to ensure backward compatibility of applications
		- Also called Application Compatibility Cache (AppCompatCache)
		- `SYSTEM\CurrentControlSet\Control\Session Manager\AppCompatCache`
		- Stores file name, file size, last modified time of the executables
		- An Eric Zimmerman tool called **AppCompatCache Parser** can be used to parse data and output it into a CSV file
		- This command can be used to run the AppCompatCache Parser tool/utility:
			- `AppCompatCacheParser.exe --csv <path-to-save-csvoutput> -f <path-to-HIVE> -c <control-set-to-parse>`
		- The output can be viewed with **EZViewer** - another one of Eric Zimmerman's tools
	- AmCache:
		- A hive related to ShimCache
		- `C:\Windows\appcompat\Programs\Amcache.hve`
		- Stores additional data to ShimCache, related to program executions
			- Execution path
			- Installation
			- Execution time
			- Deletion time
			- SHA1 hashes of executed programs
		- Information about the last executed programs can be found here in the hive:
			- `Amcache.hve\Root\File\{Volume GUID}\`
	- BAM/DAM
		- BAM - Background Activity Monitor
			- Keeps track on the activity of background applications
		- DAM - Desktop Activity Moderator
			- Part of MS Windows that optimizes the power consumption of the device
		- Both of these are part of Modern Standby systems in MS Windows
		- Contains information about last run programs, their full paths, and last execution time
			- `SYSTEM\CurrentControlSet\Services\bam\UserSEttings\{SID}`
			- `SYSTEM\CurrentControlSet\Services\dam\UserSettings\{SID}`
- External Devices/USB Device Forensics
	- Device Identification
		- These locations keep track of USB keys plugged into a system
		- These locations store the Vendor ID, Product ID, and Version of the USB device plugged in and can be used to identify unique devices
			- `SYSTEM\CurrentControlSet\Enum\USBSTOR`
			- `SYSTEM\CurrentControlSet\Enum\USB`
		- Will show when the device was first installed, last connected bits of information as well
		- The Registry Explorer tool presents information in these keys very well
	- First/Last Times
		- The following key tracks the first time the device was connected, the last time it was connected and the last time the device was removed from the system
			- `SYSTEM\CurrentControlSet\Enum\USBSTOR\Ven_Prod_version\USBSerial#\Properties\{83da6326-97a6-4088-9453-a19231573b29}\####`
			- The `####` can be replaced by the following digits to get the required information:
				- 0064 - First Connection Time
				- 0066 - Last Connection Time
				- 0067 - Last Removal Time
		- Registry Explorer will show this anywho
	- USB Device Volume Name
		- Device name of a connected device can be found here:
			- `SOFTWARE\Microsoft\Windows Portable Devices\Devices`
		- The GUID seen in this key can be compared with the Disk ID we see on other keys mentioned in device identification to correlate names with unique devices

---

Windows Forensics - File Systems
https://tryhackme.com/room/windowsforensics2

- FAT - File Allocation Table
	- https://en.wikipedia.org/wiki/File_Allocation_Table
	- Has been the default file system for MS OSes since at least the late 1970s - not the default anymore. 
	- FAT creates a table that indexes the location of bits that are allocated to different files
	- Supports these data structures:
		- Clusters
			- A basic storage unit for the file system
			- Each file is stored on a storage device can be considered a group of clusters containing bits of information
		- Directory
			- Contains information about file identification (like file name, starting cluster and filename length)
		- FAT is a linked list of all the clusters
		- Contains the status of the cluster and the pointer to the next cluster in the chain
		- The bits that make up a file are stored in clusters
	- FAT12, FAT16, FAT32
		- FAT12
			- Addressable Bits
				- 12
			- Max number of clusters
				- 4,096
			- Supported size of clusters
				- 512B - 8KB
			- Max volume size
				- 32MB
		- FAT16
			- Addressable Bits
				- 16
			- Max number of clusters
				- 65,536
			- Supported size of clusters
				- 2KB - 32KB
			- Max volume size
				- 2GB
		- FAT32
			- Addressable Bits
				- 28
			- Max number of clusters
				- 268,435,456
			- Supported size of clusters
				- 4KB - 32KB
			- Max volume size
				- 2TB
	- 4GB file and volume size limitation for both FAT16 and FAT32
- exFAT
	- The default for SD cards larger than 32GB
	- Supports a cluster size of 32MB
	- Maximum file and volume size of 128PB
	- Maximum of 2,796,202 files per directory
- NTFS
	- New Technology File System (NTFS)
	- Introduced in 1993 with Windows NT 3.1
	- Became mainstream with Windows XP
	- Provides security, reliability and recovery capabilities
	- Journaling
		- Keeps a log of changes to the metadata in the volume
		- Helps the system recover from a crash or data movement due to defragmentation
		- Log is stored in $LOGFILE in the volume's root directory
		- NTFS is called the 'journaling file system'
	- Access Controls
		- Ability to define an owner of a file/directory and permissions for each user
	- Volume Shadow Copy
		- NTFS file systems keep track of changes made to a file using a feature called the Volume Shadow Copies
		- Previous file versions can be restored for recovery or system restore
		- Ransomware actors have been noted to delete the shadow copies on a victim's file system to prevent them from recovering their data
	- ADS - Alternate Data Streams
		- Allows for files to have multiple streams of data stored in a single file
		- Browsers use ADS's to identify files downloaded from the Internet (using the ADS Zone Identifier) 
		- Malware has been noted to hide code in ADS as well
	- Master File Table (MFT)
		- A structured database that tracks the objects stored in a volume
		- Critical files in the MFT:
			- $MFT
				- The first record in the volume
				- the VBR (Volume Boot Record) points to the cluster where it is located
				- $MFT stores information about the clusters where all other objects present on the volume are located
				- This file contains a directory of all the files present on the volume
			- $LOGFILE
				- Stores the transactional logging of the file system
				- Helps to maintain the integrity of the file system in the event of a crash
			- $UsnJrnl
				- Update Sequence Number (USN) Journal
				- Present in the $Extend record
				- Contains information about all the files that were changed in the file system and the reason for the change
				- Also called the 'Change Journal'
			- MFT Explorer
				- Eric Zimmerman's tools to explore MFT files
				- Available in both CLI and GUI versions
				- `MFTEcmd.exe`
				- Parses data from different files created by the NTFS file system, like $MFT, $Boot ...
				- `MFTECmd.exe -f <path-to-$MFT-file> --csv <save-file-path>`
				- EZViewer can then be used to view the output given above
- Recovering Deleted Files
	- When a file is deleted, the file system deletes the entries that store the file's location on the disk
	- For the file system, the location where the file existed is now available for writing or unallocated
	- The file contents, however, are still physically there (providing they haven't been overwritten)
	- Disk Image File
		- A file that contains a bit-by-bit copy of a disk drive
		- Saves all the data in a disk image file, including the metadata, in a single file
		- When conducting forensics, an analyst will be able to make several copies of the physical evidence, and use them for investigation
			- The original evidence isn't contaminated
			- The disk image file can be copied to another disk and analyzed without using any specialised hardware
	- Autopsy
		- https://www.autopsy.com/download/
- Evidence of Execution
	- Artifacts that provide us evidence of execution
		- Windows Prefetch Files
			- When a program is run, it stores its information for future use
			- This information is used to load the program quickly in case of frequent use
			- The information is stored in prefetch files which are located in 
				- `C:\Windows\Prefetch`
			- File extension of `.pf`
			- `.pf` files contain the last run times of the application, the number of times the application was run and any files and device handles used by the file
			- Good source of information about the last executed programs and files
			- **Prefetch Parser** (PECmd.exe) from Eric Zimmerman can be used
				- `PECmd.exe -f <path-to-prefetch-files> --csv <path-to-save-output>`
				- `PECMD.exe -f <path-to-prefetch-directory> --csv <path-to-save-csv>`
	- Windows 10 Timeline
		- Win10 stores recently used applications and files in a SQLite db, called the Windows 10 Timeline
		- Found in
			- `C:\Users\<username>\AppData\Local\ConnectedDevicesPlatform\{randomfolder}\ActivitiesCache.db`
		- Can be a source for the last executed programs
		- **`WxTCmd.exe`** can be used for parsing the Win10 Timeline
		- Seems to be as though this is a file that is in Win11 as well (haven't tested)
		- `WxTCmd.exe -f <path-to-timeline-file> --csv <path-to-save-csv>`
	- Windows Jump Lists
		- Jump lists help users go directly to their recently used files from the taskbar
		- Files opened by other applications can be viewed here as well
		- Stored in
			- `C:\Users\<username>\AppData\Roaming\Microssoft\Windows\Recent\AutomaticDestinations`
		- Jumplists include information around the applications executed, first time of execution, and last time of execution of the application against an AppID
		- **JLECmd.exe** can be used to parse Jump Lists
		- `JLECmd.exe -f <path-to-Jumplist-file> --csv <path-to-save-csv>`
- Shortcut Files
	- There is a shortcut that is created for each file opened either locally or remotely
		- It contains information about the first and last opened times of the file and the path of the opened file, along with some other data
	- They can be found here:
		- `C:\Users\<username>\AppData\Roaming\Microsoft\Windows\Recent`
		- `C:\Users\<username>\AppData\Roaming\Microsoft\Office\Recent\`
	- **LECmd.exe** tool can be used to parse Shortcut files
	- `LECmd.exe -d C:\Users\THM-4n6\Desktop\triage\C\Users\THM-4n6\AppData\Roaming\Microsoft\Windows\Recent --csv ..\shortcuts1`
- IE/Edge History
	- The browser's history includes files opened in the system as well
	- Whether the files were open with the browser, or not
	- Found in:
		- `C:\Users\<username>\AppData\Microsoft\Windows\WebCache\WebCacheV*.dat`
	- The files/folders appear with a `file:///*` prefix
	- Autopsy can be used to view web-cache data if required (although there are other tools as well)
- Jump Lists
	- Jump Lists create a list of the last opened files
	- This information can be used to identify both the last executed programs and the last opened files in a system
	- Location:
		- `C:\Users\<username>\AppData\Roaming\Microsoft\Windows\Recent\AutomaticDestinations`
- External Devices/USB Device Forensics
	- When a new device is connected to a system, information related to the setup of said device is stored in a log
		- `setupapi.dev.log`
	- Located in:
		- `C:\Windows\inf\setupapi.dev.log`
- Shortcut Files
	- Can also sometimes provide information about connected USB devices
		- Volume name, type, and serial number