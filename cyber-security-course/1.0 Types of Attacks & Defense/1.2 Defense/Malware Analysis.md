https://tryhackme.com/room/intromalwareanalysis

- Security Operations Teams
	- These teams analyze malware to write detections for malicious activity in their networks
- Incident Response Teams
	- These teams analyze malware to determine what damage has been done to an environment to remediate and revert that damage
- Threat Hunt Teams
	- These teams analyze malware to identify IOCs, which they use to hunt for malware in the network
- Malware Researchers
	- Security product vendor teams analyze malware to add detections for them in their security products
- Threat Research Teams
	- Microsoft, Google and similar analyze malware to discover the vulnerabilities exploited and add more security features to the OS/applications

- **Always take care when analyzing malware!**
	- Analyze malware or suspected malware on a machine that is purely dedicated to analyzing malware - such as an isolated VM
		- Never use it on a machine that has other purposes. 
	- When not analyzing or moving malware samples to different locations, always keep them in a password-protected compressed file (.zip, .rar, .tar etc) 
	- Only extract the malware from this password-protected archive inside the isolated environment, and only when analyzing it
	- Create an isolated VM specifically for malware analysis, which has the capability of being reverted to a clean slate once you are finished
	- Ensure that all internet connections are closed or at least monitored
	- Once you are finished with the analysis, revert the VM to a clean slate for the next analysis to take place
	- Avoid any residue from a previous malware execution corrupting the next analysis and so on

- Most of the time there will be a PE, a malicious document file, or a .pcap file that will be analyzed. PE's are the most common type of malware that tends to be analyzed. 
- Two categories mainly
	- Static Analysis
	- Dynamic Analysis

Static Analysis
- Malware being analyzed without being executed/run
- Checking for strings, checking the PE header for information related to different sections, or looking at the code using a disassembler
- Malware often uses techniques to avoid static analysis, through obfuscation, packing, or other means of hiding its properties
Dynamic Analysis
- Running the malware in a controlled environment to observe what it does 
- Using tools installed to monitor the malware's activity
- Or in the form of sandboxes that perform this task automatically
- The advantage in running malware in a controlled environment is that the analyst is in control of the environment, it can be configured to avoid unnecessary noise (like activities from other users, or the network, other services and so on)
- Malware, however, often uses techniques to prevent an analyst from performing dynamic analysis by detecting the environment that the malware is being run on for example - the malware may then use benign code if it identifies it's being run in a controlled environment 

- The use of debuggers is common when analyzing malware

- REMNUX is a good OS for malware analysis
	- Reverse Engineering Malware Linux

Examining the File Type
- `file <file>`
- Often malware authors will try to hide what type of file(s) their malware is by changing related extensions on said files
- Checking the actual file type of a file is important

Examining Strings
- `strings <file>`
- Lists down strings present in a file
- Some strings to note could be the `URLDownloadToFile` string - which may have something to do with the URLDownloadToFile API in Windows

Calculating Hashes
- Hashes are unique identifiers for files
- Hashes are important when identifying malware as analysts can share identified malware hashes with the wider-community for easier identification of malware 
- `md5sum <filename>` 
- `sha256sum <filename>`

AV Scans and VirusTotal
- Scanning files with Anti-Virus tools and/or searching for hashes on VirusTotal are useful processes to follow
	- VT can contain information about the classification of malware performed by security researchers 
- When using an online scanner, it is recommended to search for the malware's hash as opposed to uploading the file(s) online to avoid leaking sensitive information online
- Only upload a sample if you are sure of what you are doing

PE Header
- The Portable Executable File Header contains metadata about a PE file
- Imports/Exports
	- A PE File by itself rarely contains all the code that it needs to run on a system
	- Most of the time - it reuses code provided by the OS it is running on 
	- This is done to use less space and leverage the framework the OS has laid out to perform tasks instead of 'reinventing the wheel.' 
	- Imports are functions that the PE file imports from outside to carry out different tasks
		- ie - if a developer wants to query a Windows Registry value, they will import the `RegQueryValue` function provided by Microsoft instead of writing the whole code for that function themselves
		- It's safe to say that this function will live on any Windows machine
	- Export functions are exposed to other binaries that can use that function instead of implementing it themselves
		- Generally associated with DLL (Dynamically-Linked Libraries) files and it is not typical for a non-DLL PE file to have a lot of exports
	- Since most PE files use the Windows API to perform the bulk of their jobs, PE file imports provide crucial information on what the PE file will and is doing
		- An `InternetOpen` function will communicate with the Internet
		- A `URLDownloadToFile` function shows that a PE file will download something from the Internet
		- And so on
	- Naming conventions of the Windows API are generally human-friendly and intuitive 
	- There is the Windows Documentation read to clarify assumptions
		- https://learn.microsoft.com/en-us/windows/win32/api/_winprog/

Sections
- A PE File is divided into different sections which have different purposes
- Sections depend on the compiler or packer to compile/pack the binary - the following are the most commonly seen sections in a PE file
	- `.text` - generally contains the CPU instructions executed when a PE file is run. 
		- This section is marked as executable
	- `.data` - contains the global variables and other global data used by the PE file
	- `.rsrc` - Contains resources that are used by the PE file, images, icons and so on

Analyzing PE Header Using the `pecheck` Utility
- The `pecheck` utility (that is available by default in Remnux OS) can be used to check PE Headers

`pe-tree`
- Allows analysts to view PE files in a tree-view style display using `pefile` 

Basic Dynamic Analysis
- May properties of a malware sample can be hidden when it is not running
- REMEMBER - Use an isolated VM with a clean snapshot so that you can restore to a clean-slate of the VM when your processing is complete
	- Don't leave nasties around :) 
- A sandbox is an isolated environment mimicking the actual target environment of a malware
	- Analysts can run a sample to learn more about the focused malware sample in such environments
	- Heavily reliant on VMs

- Construction of a Sandbox
	- VM mimicking the actual target environment of the malware sample
	- Ability to take snapshots and revert to a clean slate
	- OS monitoring software, for example, Procmon, ProcExplorer, or Regshot etc
	- Networking monitoring software, like Wireshark, tcpdump, and so on
	- Control over the network through a dummy DNS server and webserver
	- A mechanism to move analysis logs and malware samples in and out of the VM without compromising the host!!!!
		- (Be very careful with this one. If you have a shared directory with your malware analysis VM that remains accessible when running malware, you risk malware affecting all files through your shared directory and potentially into your own hosting system as well - needing to find a good process around this one and I'm glad the module talked about this)

Open Source Sandboxes
- Cuckoo's Sandbox
	- https://github.com/cuckoosandbox/cuckoo
	- Developed as part of a Google Summer of Code project in 2010
	- Open-source project
	- A lot of customizations available
	- You can deploy it on your network and let the community signatures guide you into identifying which files are malicious and which files are benign because of the vast corpus of community signatures that come with it
	- Doesn't support Python3 yet..... It's been archived, an update is pending.
- CAPE Sandbox
	- More advanced version of Cuckoo's
	- Supports debugging and memory dumping to support the unpacking of packed malware
- Online Sandboxes
	- Best to not submit a sample to online sb's - unless you know what you are doing
	- Cuckoo Online
		- https://cuckoo.cert.ee/
	- Any.Run
		- https://any.run/
	- Intezer
		- https://analyze.intezer.com/
	- Hybrid Analysis
		- https://hybrid-analysis.com/
	- You can upload hashes to say for example the Hybrid Analysis tool to find out what community investigations that have already taken place have resulted in 

Anti-analysis Techniques
- Packing and Obfuscation
- A malware author may obfuscate, compress and/or encrypt contents of malware
	- Making it difficult to analyze
- Packed malware will not show important information when running a string search against it
- Packed malware may not have a .text section, and other sections have execute permissions - which may show that these section contain executable instructions or will be populated with executable instructions during execution
- Unpacking malware samples will be the route to take which will be covered later (hopefully)

Sandbox Evasion
- Long sleep calls
	- Malware authors know that sandboxes run for a limited time
	- They may program the malware not to perform any activity for a long time after execution
	- Intention here is to time out the sandbox
- User Activity Detection
	- Some samples will wait for user activity before performing malicious activity
	- The premise of this technique is that there will be no user in a sandbox
		- Therefore there will be no mouse movement or typing on the keyboard
	- Advanced malware also detects patterns in mouse movements that are often used in automated sandboxes 
		- Designed to bypass automated sandbox detection
- Footprinting User Activity
	- Some malware check for user files or activity
	- Like if there are any files in the MS Office history or Internet browsing history
- Detecting VMs
	- Sandboxes run on VMs 
	- VMs leave artifacts that can be identified by malware
	- ie drivers installed on VMs being run on VMWare or VirtualBox give away the fact that the machine is a VM
	- Malware authors often associate VMs with sandboxes and would terminate the malware if a VM is detected
- 